(function(){function m(d,a){a||(a={});for(var b in d)void 0===a[b]&&(a[b]=d[b]);return a}function h(){this._callbacks=[];this._errCallbacks=[];this._resolved=0;this._result=null}function f(d,a){this.data=d;this.options=m(r,a);this.operation=new h;this.operation.resolve(null,this.data);this.requiredScripts=[];this.requiredFunctions=[]}var s="undefined"!==typeof module&&module.exports,k=!("undefined"!==typeof window&&this===window),n=n||function(d){setTimeout(d,0)},l=k?require(__dirname+"/Worker.js"):
self.Worker,q="undefined"!==typeof self?self.URL?self.URL:self.webkitURL:null,t=k||self.Worker?!0:!1;h.prototype.resolve=function(d,a){if(d){this._resolved=2;this._result=d;for(var b=0;b<this._errCallbacks.length;++b)this._errCallbacks[b](a)}else for(this._resolved=1,this._result=a,b=0;b<this._callbacks.length;++b)this._callbacks[b](a);this._callbacks=[];this._errCallbacks=[]};h.prototype.then=function(d,a){if(1===this._resolved)d&&d(this._result);else if(2===this._resolved)a&&a(this._result);else return d&&
(this._callbacks[this._callbacks.length]=d),a&&(this._errCallbacks[this._errCallbacks.length]=a),this};var r={evalPath:k?__dirname+"/eval.js":null,maxWorkers:k?require("os").cpus().length:4,synchronous:!0,env:{},envNamespace:"env"};f.isSupported=function(){return t};f.prototype.getWorkerSource=function(d,a){var b="",e=0;k||0===this.requiredScripts.length||(b+='importScripts("'+this.requiredScripts.join('","')+'");\r\n');for(e=0;e<this.requiredFunctions.length;++e)b=this.requiredFunctions[e].name?
b+("var "+this.requiredFunctions[e].name+" = "+this.requiredFunctions[e].fn.toString()+";"):b+this.requiredFunctions[e].fn.toString();a=JSON.stringify(a||{});e=this.options.envNamespace;return k?b+'process.on("message", function(e) {global.'+e+" = "+a+";process.send(JSON.stringify(("+d.toString()+")(JSON.parse(e).data)))})":b+"self.onmessage = function(e) {var global = {}; global."+e+" = "+a+";self.postMessage(("+d.toString()+")(e.data))}"};f.prototype.require=function(){for(var d=Array.prototype.slice.call(arguments,
0),a,b=0;b<d.length;b++)a=d[b],"string"===typeof a?this.requiredScripts.push(a):"function"===typeof a?this.requiredFunctions.push({fn:a}):"object"===typeof a&&this.requiredFunctions.push(a);return this};f.prototype._spawnWorker=function(d,a){var b,e=this.getWorkerSource(d,a);if(k)b=new l(this.options.evalPath),b.postMessage(e);else{if(void 0===l)return;try{if(0!==this.requiredScripts.length)if(null!==this.options.evalPath)b=new l(this.options.evalPath),b.postMessage(e);else throw Error("Can't use required scripts without eval.js!");
else if(q){var c=new Blob([e],{type:"text/javascript"}),g=q.createObjectURL(c);b=new l(g)}else throw Error("Can't create a blob URL in this browser!");}catch(p){if(null!==this.options.evalPath)b=new l(this.options.evalPath),b.postMessage(e);else throw p;}}return b};f.prototype.spawn=function(d,a){var b=this,e=new h;a=m(this.options.env,a||{});this.operation.then(function(){var c=b._spawnWorker(d,a);if(void 0!==c)c.onmessage=function(a){c.terminate();b.data=a.data;e.resolve(null,b.data)},c.postMessage(b.data);
else if(b.options.synchronous)n(function(){b.data=d(b.data);e.resolve(null,b.data)});else throw Error("Workers do not exist and synchronous operation not allowed!");});this.operation=e;return this};f.prototype._spawnMapWorker=function(d,a,b,e){var c=this,g=c._spawnWorker(a,e);if(void 0!==g)g.onmessage=function(a){g.terminate();c.data[d]=a.data;b()},g.postMessage(c.data[d]);else if(c.options.synchronous)n(function(){c.data[d]=a(c.data[d]);b()});else throw Error("Workers do not exist and synchronous operation not allowed!");
};f.prototype.map=function(d,a){function b(){++g===e.data.length?p.resolve(null,e.data):c<e.data.length&&e._spawnMapWorker(c++,d,b,a)}a=m(this.options.env,a||{});if(!this.data.length)return this.spawn(d,a);var e=this,c=0,g=0,p=new h;this.operation.then(function(){for(;c-g<e.options.maxWorkers&&c<e.data.length;++c)e._spawnMapWorker(c,d,b,a)});this.operation=p;return this};f.prototype._spawnReduceWorker=function(d,a,b,e){var c=this,g=c._spawnWorker(a,e);if(void 0!==g)g.onmessage=function(a){g.terminate();
c.data[c.data.length]=a.data;b()},g.postMessage(d);else if(c.options.synchronous)n(function(){c.data[c.data.length]=a(d);b()});else throw Error("Workers do not exist and synchronous operation not allowed!");};f.prototype.reduce=function(d,a){function b(f){--e;1===c.data.length&&0===e?(c.data=c.data[0],g.resolve(null,c.data)):1<c.data.length&&(++e,c._spawnReduceWorker([c.data[0],c.data[1]],d,b,a),c.data.splice(0,2))}a=m(this.options.env,a||{});if(!this.data.length)throw Error("Can't reduce non-array data");
var e=0,c=this,g=new h;this.operation.then(function(){if(1===c.data.length)g.resolve(null,c.data[0]);else{for(var f=0;f<c.options.maxWorkers&&f<Math.floor(c.data.length/2);++f)++e,c._spawnReduceWorker([c.data[2*f],c.data[2*f+1]],d,b,a);c.data.splice(0,2*f)}});this.operation=g;return this};f.prototype.then=function(d,a){var b=this,e=new h;this.operation.then(function(){var a=d(b.data);void 0!==a&&(b.data=a);e.resolve(null,b.data)},a);this.operation=e;return this};s?module.exports=f:self.Parallel=f})();